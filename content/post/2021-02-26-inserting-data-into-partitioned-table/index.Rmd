---
title: Inserting Data into Partitioned Table
author: Konrad Zdeb
date: '2021-02-26'
slug: []
categories:
  - how-to
  - example
tags:
  - R
  - Spark
references:
- id: costa2019
  title: Evaluating partitioning and bucketing strategies for Hive‚Äêbased Big Data Warehousing systems
  author:
  - family: Costa
    given: Eduarda
  - family: Costa
    given: Carlos
  - family: Santos
    given: Maribel Yasmina
  container-title: Journal of Big Data
  volume: 6
  URL: 'https://doi.org/10.1186/s40537-019-0196-1'
  DOI: 10.1186/s40537-019-0196-1
  issue: 34
  publisher: Nature Publishing Group
  page: 1-38
  type: article-journal
  issued:
    year: 2019
    month: 4
---

# Rationale
Maintaining partitioned Hive tables is a frequent practice in a business. Properly structured tables are conducive to achieving robust performance through speeding up query execution [see @costa2019]. Frequent use cases pertain to creating tables with hierarchical partition structure. In context of a data that is refreshed daily, the frequently utilised partition structure reflects years, months and dates. 

## Creating partitioned table

In HiveQL we would create the table with the following structure using the syntax below. In order to keep the development tidy, I'm creating a separate database on Hive which I will use for the purpose of creating tables for this article.

```{sql, eval=FALSE}
-- Initially test database is created to keep the development tidy
CREATE DATABASE blog COMMENT 'Blog article samples, can be deleted.';
-- Example table is created
CREATE TABLE blog.sample_partitioned_table (
		value_column_a FLOAT 	COMMENT 'Column will hold 4-byte number', 
		value_column_b DOUBLE 	COMMENT '8-byte double precision', 
		value_column_c CHAR(1) 	COMMENT 'Fixed length varchar') 
	COMMENT 'Sample partitioned table stored as text file' 
	PARTITIONED BY (
		part_year SMALLINT 	COMMENT 'Data load year, partition', 
		part_month TINYINT 	COMMENT 'Data load month, partition',
		part_day TINYINT	COMMENT 'Data load day, partition')
	ROW FORMAT DELIMITED
	FIELDS TERMINATED BY '\t'
	LINES TERMINATED BY '\n'
	STORED AS TEXTFILE;
```
The code snippet above achieves the following:
 
- Table `sample_partitioned_table` is created within newly created database `blog`.
- Three value columns are defined of `FLOAT`, `DOUBLE` and `CHAR(1)` types. Hive offers fairly rich set of data types and it's worth to study [the official documentation](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Types) in order to ensure that selection of types is optimal considering the data we want to feed into the table. If we don't have this clarity the wise solution may be to use more common types likes `INT`.
- The `blog.sample_partitioned_table` is stored as a text file with lines separated by tabs and rows separated with end line.
- The table defines theree columns used to partition the data, `tinyint` type is suitable to hold values from -127 to 127 so it can be used to store day and month values, `smallint` type holds values from -32,768 to 32,768 so it's suitable for storing annual data.

For more substantial tables with frequent usage further consideration should be given to the [Hive file formats](https://cwiki.apache.org/confluence/display/Hive/FileFormats) as well as wider storage strategy aspects. 

## Inserting data from R

Inserting data using packages like [`glue`](https://glue.tidyverse.org/) in R is trivial, and enables us to deliver highly readable code that will be easy to maintain.

### Sample data

In an actual production setting, we would expect that our run will generate a data consistent with the table structure that should be saved as one of partitions. A common scenario could reflect summary events data generated for specific day, in business that structure would be frequently used to develop views on periodical business activity. For the purpose of example, I'm generating some sample data in R.

```{r sample_data}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
# Generating two months of data
dates <- seq.Date(
    from = as.Date("01-01-2010", format = "%d-%m-%Y"),
    to = as.Date("28-02-2010", format = "%d-%m-%Y"),
    by = "day"
)
# Each data will contain two rows of values corresponding to the column types
# that were previously defined in Hive
lst_sample_data <- map(.x = dates, ~ tibble(val_a = runif(2),
                                            val_b = runif(2),
                                            val_c = sample(letters, 2),
                                            update_year = year(.x),
                                            update_month = month(.x),
                                            update_day = day(.x)))
```

The created data looks as follows:
```{r list_preview}
str(lst_sample_data[1:5], max.level = 1)
```

with each table consisting of two values we want to insert and corresponding partition columns.

```{r single_table_preview}
lst_sample_data[[1]]
```


# References
