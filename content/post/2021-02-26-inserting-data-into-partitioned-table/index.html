---
title: Inserting Data into Partitioned Table
author: Konrad Zdeb
date: '2021-02-26'
slug: []
categories:
  - how-to
  - example
tags:
  - R
  - Spark
references:
- id: costa2019
  title: Evaluating partitioning and bucketing strategies for Hive‐based Big Data Warehousing systems
  author:
  - family: Costa
    given: Eduarda
  - family: Costa
    given: Carlos
  - family: Santos
    given: Maribel Yasmina
  container-title: Journal of Big Data
  volume: 6
  URL: 'https://doi.org/10.1186/s40537-019-0196-1'
  DOI: 10.1186/s40537-019-0196-1
  issue: 34
  publisher: Nature Publishing Group
  page: 1-38
  type: article-journal
  issued:
    year: 2019
    month: 4
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<div id="rationale" class="section level1">
<h1>Rationale</h1>
<p>Maintaining partitioned Hive tables is a frequent practice in a business. Properly structured tables are conducive to achieving robust performance through speeding up query execution <span class="citation">(see <a href="#ref-costa2019" role="doc-biblioref">Costa, Costa, and Santos 2019</a>)</span>. Frequent use cases pertain to creating tables with hierarchical partition structure. In context of a data that is refreshed daily, the frequently utilised partition structure reflects years, months and dates.</p>
<div id="creating-partitioned-table" class="section level2">
<h2>Creating partitioned table</h2>
<p>In HiveQL we would create the table with the following structure using the syntax below. In order to keep the development tidy, I’m creating a separate database on Hive which I will use for the purpose of creating tables for this article.</p>
<pre class="sql"><code>-- Initially test database is created to keep the development tidy
CREATE DATABASE blog COMMENT &#39;Blog article samples, can be deleted.&#39;;
-- Example table is created
CREATE TABLE blog.sample_partitioned_table (
        value_column_a FLOAT    COMMENT &#39;Column will hold 4-byte number&#39;, 
        value_column_b DOUBLE   COMMENT &#39;8-byte double precision&#39;, 
        value_column_c CHAR(1)  COMMENT &#39;Fixed length varchar&#39;) 
    COMMENT &#39;Sample partitioned table stored as text file&#39; 
    PARTITIONED BY (
        part_year SMALLINT  COMMENT &#39;Data load year, partition&#39;, 
        part_month TINYINT  COMMENT &#39;Data load month, partition&#39;,
        part_day TINYINT    COMMENT &#39;Data load day, partition&#39;)
    ROW FORMAT DELIMITED
    FIELDS TERMINATED BY &#39;\t&#39;
    LINES TERMINATED BY &#39;\n&#39;
    STORED AS TEXTFILE;</code></pre>
<p>The code snippet above achieves the following:</p>
<ul>
<li>Table <code>sample_partitioned_table</code> is created within newly created database <code>blog</code>.</li>
<li>Three value columns are defined of <code>FLOAT</code>, <code>DOUBLE</code> and <code>CHAR(1)</code> types. Hive offers fairly rich set of data types and it’s worth to study <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Types">the official documentation</a> in order to ensure that selection of types is optimal considering the data we want to feed into the table. If we don’t have this clarity the wise solution may be to use more common types likes <code>INT</code>.</li>
<li>The <code>blog.sample_partitioned_table</code> is stored as a text file with lines separated by tabs and rows separated with end line.</li>
<li>The table defines theree columns used to partition the data, <code>tinyint</code> type is suitable to hold values from -127 to 127 so it can be used to store day and month values, <code>smallint</code> type holds values from -32,768 to 32,768 so it’s suitable for storing annual data.</li>
</ul>
<p>For more substantial tables with frequent usage further consideration should be given to the <a href="https://cwiki.apache.org/confluence/display/Hive/FileFormats">Hive file formats</a> as well as wider storage strategy aspects.</p>
</div>
<div id="inserting-data-from-r" class="section level2">
<h2>Inserting data from R</h2>
<p>Inserting data using packages like <a href="https://glue.tidyverse.org/"><code>glue</code></a> in R is trivial, and enables us to deliver highly readable code that will be easy to maintain.</p>
<div id="sample-data" class="section level3">
<h3>Sample data</h3>
<p>In an actual production setting, we would expect that our run will generate a data consistent with the table structure that should be saved as one of partitions. A common scenario could reflect summary events data generated for specific day, in business that structure would be frequently used to develop views on periodical business activity. For the purpose of example, I’m generating some sample data in R.</p>
<pre class="r"><code>suppressPackageStartupMessages(library(tidyverse))
# Generating two months of data
dates &lt;- seq.Date(
    from = as.Date(&quot;01-01-2010&quot;, format = &quot;%d-%m-%Y&quot;),
    to = as.Date(&quot;28-02-2010&quot;, format = &quot;%d-%m-%Y&quot;),
    by = &quot;day&quot;
)
# Each data will contain two rows of values corresponding to the column types
# that were previously defined in Hive
lst_sample_data &lt;- map(.x = dates, ~ tibble(val_a = runif(2),
                                            val_b = runif(2),
                                            val_c = sample(letters, 2)))</code></pre>
<p>The created data looks as follows:</p>
<pre class="r"><code>str(lst_sample_data[1:5], max.level = 1)</code></pre>
<pre><code>## List of 5
##  $ : tibble [2 × 3] (S3: tbl_df/tbl/data.frame)
##  $ : tibble [2 × 3] (S3: tbl_df/tbl/data.frame)
##  $ : tibble [2 × 3] (S3: tbl_df/tbl/data.frame)
##  $ : tibble [2 × 3] (S3: tbl_df/tbl/data.frame)
##  $ : tibble [2 × 3] (S3: tbl_df/tbl/data.frame)</code></pre>
<p>with each table consisting of two values we want to insert and corresponding partition columns.</p>
<pre class="r"><code>lst_sample_data[[1]]</code></pre>
<pre><code>## # A tibble: 2 x 3
##   val_a val_b val_c
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
## 1 0.983 0.586 t    
## 2 0.517 0.393 d</code></pre>
</div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-costa2019" class="csl-entry">
Costa, Eduarda, Carlos Costa, and Maribel Yasmina Santos. 2019. <span>“Evaluating Partitioning and Bucketing Strategies for Hive‐based Big Data Warehousing Systems.”</span> <em>Journal of Big Data</em> 6 (34): 1–38. <a href="https://doi.org/10.1186/s40537-019-0196-1">https://doi.org/10.1186/s40537-019-0196-1</a>.
</div>
</div>
</div>
